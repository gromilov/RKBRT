---
import StarIcon from '../assets/star.svg';
import PrevIcon from '../assets/prev.svg';
import NextIcon from '../assets/next.svg';
import QuoteIcon from '../assets/quote.svg';
import Modal from '../components/ui/Modal.astro';

// Данные отзывов
const reviewsData = [
  {
    id: 1,
    author: "Мукаева Елена Юрьевна",
    date: "18.09.2025 года",
    doctor: "Муниров Рустем Юрисович",
    text: "Муниров Рустем Юрисович провел операцию моему папе Мукаеву Ю. И. Выражаю громадную благодарность Рустему Юрисовичу за благополучно проведённую операцию, за душевное и профессиональное отношение в предоперационный и послеоперационный периоды! Здоровья Вам!",
    rating: 5
  },
  {
    id: 2,
    author: "Мукаева Елена Юрьевна",
    doctor: "Сабиров Акмал Абдираимович",
    text: "От всей души хочу выразить свою благодарность Сабирову Акмалу Абдираимович. Акмал Адираимович профессионал, хороший специалист своего дела и просто хороший человек с чувством юмора. Более 2х часов провел операцию, всё объяснил, дал рекомендации. Надеюсь всё будет хорошо. Он человек с золотыми руками и большой",
    rating: 4
  },
  {
    id: 3,
    author: "Мукаева Елена Юрьевна",
    doctor: "Сабиров Акмал Абдираимович",
    text: "От всей души хочу выразить свою благодарность Сабирову Акмалу Абдираимович. Акмал Адираимович профессионал, хороший специалист своего дела и просто хороший человек с чувством юмора. Более 2х часов провел операцию, всё объяснил, дал рекомендации. Надеюсь всё будет хорошо. Он человек с золотыми руками и большой",
    rating: 5
  },
  {
    id: 4,
    author: "Мукаева Елена Юрьевна",
    doctor: "Сабиров Акмал Абдираимович",
    text: "От всей души хочу выразить свою благодарность Сабирову Акмалу Абдираимович. Акмал Адираимович профессионал, хороший специалист своего дела и просто хороший человек с чувством юмора. Более 2х часов провел операцию, всё объяснил, дал рекомендации. Надеюсь всё будет хорошо. Он человек с золотыми руками и большой",
    rating: 4
  },
  {
    id: 5,
    author: "Мукаева Елена Юрьевна",
    doctor: "Сабиров Акмал Абдираимович",
    text: "От всей души хочу выразить свою благодарность Сабирову Акмалу Абдираимович. Акмал Адираимович профессионал, хороший специалист своего дела и просто хороший человек с чувством юмора. Более 2х часов провел операцию, всё объяснил, дал рекомендации. Надеюсь всё будет хорошо. Он человек с золотыми руками и большой",
    rating: 5
  },
];
---

<div class="reviews-section">
  <!-- Заголовок раздела -->
  <h2 class="reviews-section__title">Отзывы</h2>

  <!-- Карусель Owl Carousel -->
  <div class="owl-carousel reviews-carousel">
    {reviewsData.map((review) => (
      <div class="review-card" key={review.id}>
        <!-- Заголовок карточки -->
        <div class="review-card__header">
          <h3 class="review-card__author">{review.author}</h3>
          <QuoteIcon />
        </div>

        <!-- Рейтинг -->
        <div class="review-card__rating">
          {Array.from({ length: review.rating }).map((_, i) => (
            <StarIcon />
          ))}
        </div>

        <!-- Текст отзыва -->
        <div class="review-card__content">
          <p class="review-card__text">
            {review.doctor && (
              <strong>{review.doctor}</strong>
            )}
            {review.text}
          </p>
          <button class="review-card__read-more" style="display: none;">
            Читать полностью
          </button>
        </div>
      </div>
    ))}
  </div>

  <!-- Навигация -->
  <div class="reviews-navigation">
    <div class="reviews-controls">
      <button class="reviews-button reviews-button--prev owl-prev">
        <PrevIcon />
      </button>
      <div class="reviews-pagination">
        <div class="owl-dots" id="customDots"></div>
      </div>
      
      <button class="reviews-button reviews-button--next owl-next">
        <NextIcon />
      </button>
    </div>
  </div>
</div>

<!-- Модальное окно для отзывов -->
<Modal id="reviewModal">
  <div class="modal-review-content">
    <div class="modal-review-header">
      <h3 class="modal-review-author"></h3>
      <QuoteIcon />
    </div>
    <div class="modal-review-rating"></div>
    <div class="modal-review-text"></div>
  </div>
</Modal>

<script>
$(document).ready(function(){
  // Инициализация карусели
  $('.reviews-carousel').owlCarousel({
    margin: 12,
    nav: false,
    dots: true,
    dotsContainer: '#customDots',
    responsive: {
      0: {
        items: 1
      },
      768: {
        items: 2
      },
      1024: {
        items: 3
      }
    },
    onInitialized: function(event) {
      updateProgress(event);
      checkTextOverflow();
    },
    onTranslated: function(event) {
      updateProgress(event);
      checkTextOverflow();
    },
    onResized: function(event) {
      checkTextOverflow();
    }
  });

  // Кастомные кнопки навигации
  $('.reviews-button--next').click(function() {
    $('.reviews-carousel').trigger('next.owl.carousel');
  });
  
  $('.reviews-button--prev').click(function() {
    $('.reviews-carousel').trigger('prev.owl.carousel');
  });

  // Функция для обновления прогресса
  function updateProgress(event) {
    const current = event.item.index + 1;
    const total = event.item.count;
    const progress = (current / total) * 100;
    $('.pagination-progress').css('width', progress + '%');
  }

  // Кастомные точки
  $('.reviews-carousel').on('initialized.owl.carousel', function(event) {
    const dots = $('#customDots');
    dots.empty();
    
    for (let i = 0; i < event.item.count; i++) {
      dots.append('<button class="owl-dot"><span></span></button>');
    }
    
    $('.owl-dot').each(function(index) {
      $(this).click(function() {
        $('.reviews-carousel').trigger('to.owl.carousel', [index]);
      });
    });
  });

  // Проверка переполнения текста и показ кнопки "Читать полностью"
  function checkTextOverflow() {
    $('.review-card').each(function() {
      const $textElement = $(this).find('.review-card__text');
      const $readMoreBtn = $(this).find('.review-card__read-more');
      
      // Проверяем, превышает ли текст 7 строк
      if (isTextOverflowing($textElement[0])) {
        $readMoreBtn.show();
      } else {
        $readMoreBtn.hide();
      }
    });
  }

  // Функция проверки переполнения текста
  function isTextOverflowing(element) {
    const lineHeight = parseInt(getComputedStyle(element).lineHeight);
    const maxHeight = lineHeight * 7; // 7 строк
    return element.scrollHeight > maxHeight;
  }

  // Обработчик кнопки "Читать полностью"
  $(document).on('click', '.review-card__read-more', function() {
    const $card = $(this).closest('.review-card');
    const author = $card.find('.review-card__author').text();
    const rating = $card.find('.review-card__rating').html();
    const text = $card.find('.review-card__text').html();
    
    openReviewModal(author, rating, text);
  });

  // Функция открытия модального окна с отзывом
  function openReviewModal(author, rating, text) {
    $('#reviewModal .modal-review-author').text(author);
    $('#reviewModal .modal-review-rating').html(rating);
    $('#reviewModal .modal-review-text').html(text);
    openModal('reviewModal');
  }

  // Проверка при загрузке и изменении размера окна
  $(window).on('load resize', function() {
    setTimeout(checkTextOverflow, 100);
  });
});
</script>

<style lang="scss" is:global>
.reviews-section {
  max-width: $container-size;
  padding: 40px 0;
  margin: 0 auto;

  &__title {
    font-size: 40px;
    font-weight: $font-weight-bold;
    color: $color-text-primary;
    text-align: center;
    margin-bottom: 48px;
    letter-spacing: -0.01em;
  }
}

/* Стили для Owl Carousel */
.reviews-carousel {
  margin-bottom: 40px;
  
  .owl-stage {
    display: flex;
  }
}

.review-card {
  background: $color-bg-hover;
  border-radius: 24px;
  padding: 32px;
  height: 366px;
  display: flex;
  flex-direction: column;
  position: relative;

  &__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
  }

  &__author {
    font-size: 18px;
    font-weight: $font-weight-medium;
    color: $color-text-primary;
    margin: 0;
    line-height: $line-height-tight;
  }

  &__rating {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    
    svg {
      width: 20px;
      height: 20px;
    }
  }

  &__content {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  &__text {
    font-size: 16px;
    color: $color-text-primary;
    line-height: $line-height-relaxed;
    margin: 0;
    flex: 1;
    
    /* Ограничение текста до 7 строк */
    display: -webkit-box;
    -webkit-line-clamp: 7;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    
    strong {
      font-weight: $font-weight-semibold;
    }
  }

  &__read-more {
    background: none;
    border: none;
    color: $color-primary;
    font-size: 16px;
    cursor: pointer;
    padding: 0;
    margin-top: 8px;
    align-self: flex-start;
    transition: color $transition-fast;

    &:hover {
      color: $color-primary-dark;
    }
  }
}

/* Стили для контента модального окна с отзывом */
.modal-review-content {
  .modal-review-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
  }

  .modal-review-author {
    font-size: 20px;
    font-weight: $font-weight-medium;
    color: $color-text-primary;
    margin: 0;
  }

  .modal-review-rating {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    
    svg {
      width: 20px;
      height: 20px;
    }
  }

  .modal-review-text {
    font-size: 16px;
    color: $color-text-primary;
    line-height: $line-height-relaxed;
    
    strong {
      font-weight: $font-weight-semibold;
    }
  }
}

/* Остальные стили остаются без изменений */
.reviews-navigation {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  margin: 0 auto;
}

.reviews-pagination {
  display: flex;
  align-items: center;
  justify-content: center;
  flex: 1;
  min-width: 100px;
  width: 240px;
  max-width: 100%;
}

.owl-dots {
  display: flex;
  justify-content: center;
}

.owl-dot {
  width: 32px;
  height: 2px;
  border: none;
  background: rgba(15, 23, 42, 0.2);
  cursor: pointer;
  transition: all 0.3s ease;
  padding: 0;
  
  &.active,
  &:hover {
    background: $color-primary;
  }
}

.reviews-controls {
  display: flex;
  gap: 12px;
  align-items: center;
}

.reviews-button {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  border: none;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all $transition-normal;
  border: 1px solid rgba(15, 23, 42, 0.12);

  &:hover {
    background: $color-bg-hover;
  }

  &.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    
    &:hover {
      background: white;
    }
  }
}

/* Адаптивность */
@media (max-width: $breakpoint-lg) {
  .review-card {
    height: auto;
    min-height: 366px;
  }
}

@media (max-width: $breakpoint-md) {
  .reviews-section__title {
    font-size: 32px;
    margin-bottom: 32px;
  }

  .review-card {
    padding: 24px;
    
    &__author {
      font-size: 16px;
    }
    
    // &__text {
    //   font-size: 14px;
    // }
  }

  .reviews-navigation {
    flex-direction: column;
    gap: 24px;
  }

  .reviews-pagination {
    max-width: 200px;
  }
}

@media (max-width: $breakpoint-sm) {
  .reviews-section {
    padding: 32px 16px;
  }

  .review-card {
    padding: 20px;
    
    &__header {
      flex-direction: column;
      gap: 12px;
    }
  }

  .reviews-controls {
    width: 100%;
    justify-content: center;
  }
}

/* Отключаем стандартные стили Owl Carousel для точек */
.owl-carousel .owl-dots,
.owl-carousel .owl-nav {
  display: none !important;
}
</style>